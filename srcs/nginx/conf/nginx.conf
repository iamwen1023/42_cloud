user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
        worker_connections 768;
}

http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        sendfile on;
        keepalive_timeout 65;

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # Disable default site includes to avoid conflicts
        # include /etc/nginx/conf.d/*.conf;
        # include /etc/nginx/sites-enabled/*;

        # HTTP server - redirect to HTTPS
        server {
                listen 80 default_server;
                server_name _;
                
                # Let's Encrypt challenge
                location /.well-known/acme-challenge/ {
                        root /var/www/certbot;
                }
                
                # Redirect all other traffic to HTTPS
                location / {
                        return 301 https://$host$request_uri;
                }
        }

        # HTTPS server
        server {
                listen 443 ssl http2 default_server;
                server_name _;
                root /var/www/wordpress;
                index index.php index.html index.htm;

                # SSL configuration (self-signed)
                ssl_certificate /etc/ssl/self-signed/fullchain.pem;
                ssl_certificate_key /etc/ssl/self-signed/privkey.pem;
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
                ssl_prefer_server_ciphers off;
                ssl_session_cache shared:SSL:10m;
                ssl_session_timeout 10m;

                # Security headers
                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                add_header X-Frame-Options DENY;
                add_header X-Content-Type-Options nosniff;
                add_header X-XSS-Protection "1; mode=block";

                location / {
                        try_files $uri /index.php?$args;
                }

                location ~ \.php$ {
                        include fastcgi_params;
                        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                        fastcgi_index index.php;
                        fastcgi_pass wordpress:9000;
                }

                # PHP-MyAdmin proxy with basic authentication
                location /phpmyadmin/ {
                        auth_basic "Restricted Access";
                        auth_basic_user_file /etc/nginx/.htpasswd;
                        
                        proxy_pass http://phpmyadmin:80/;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_redirect off;
                }
        }
}